<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <title>flask+d3 Hello World</title>

    <script src="http://d3js.org/d3.v2.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <style>

/* For table data */
td, th {
    padding: 1px 4px;
}

#intro  {
    padding:1em;
}

path.line {
    fill: none;
    stroke: #666;
    stroke-width: 1.5px;
}

.domain {
    stroke-width: 1px;
}

circle {
    cursor: pointer;
}

.axis {
    shape-rendering: crispEdges;
}

.axis line, .axis path {
    stroke-width: 1px;
    stroke: #000;
    fill: none;
}

.tooltip {
    display: none;
}

.tooltip.active {
    display: block;
}

.tooltip rect {
    fill: #ff0000;
}

    </style>

</head>
<body>
    <h1>iBacon Map in d3.js &amp; Flask</h1>
    <div id="intro">
    	Update values!
    </div>
	<p> Polled data:</p>
	<div id="update">
	
	</div>

    <script>
		$(document).ready(function() {
			(function poll() {
				setTimeout(function() {
					$.ajax({
						url: "/getdists",
						type: "GET",
						success: function(data) {
							draw_update('#update', data);
							//console.log("Poll")
						},
						dataType: "json",
						complete: poll,
						timeout: 1000
					}) //, 5000  <-- oops.
				}, 1000); // <-- should be here instead
			})();
		});
        // Load the data.
        var callback = function (data) {
			draw_update('#update', data)
        };

		var draw_update = function(reference, data) {
			$(reference).empty();
			var str = ''
			for (var dict in data) {
				str += 'userId: ' + 
					data[dict]['userId'] + 
					' distance: ' + 
					data[dict]['distance'] + '<p>'
				//console.log('Drawing the update on reference ' + reference)
			}
			$(reference).html(str)
		}

		d3.json("/getdists", callback);

    </script>

</body>
</html>
